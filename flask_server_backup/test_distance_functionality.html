<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–¢–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=9a3beffb-a8a0-4d55-850f-d258dd28c104&lang=ru_RU" type="text/javascript"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }
        #map {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            margin: 20px 0;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
        }
        input {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        button {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
        }
        button:hover {
            opacity: 0.8;
        }
        .info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è</h1>
        <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è.</p>
        
        <div class="info">
            <h3>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</h3>
            <ol>
                <li>–ù–∞–∂–º–∏—Ç–µ "üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ" –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É</li>
                <li>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –æ–¥–Ω–æ –∏–∑ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π (–∫—Ä–∞—Å–Ω—ã–µ —Ç–æ—á–∫–∏)</li>
                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–∏–ª–∏—Å—å</li>
            </ol>
        </div>

        <div id="map"></div>

        <div class="info">
            <h3>üìç –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</h3>
            <input type="text" id="user-lat" placeholder="–®–∏—Ä–æ—Ç–∞" readonly>
            <input type="text" id="user-lng" placeholder="–î–æ–ª–≥–æ—Ç–∞" readonly>
            <button onclick="getCurrentLocation()">üìç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
        </div>

        <div class="info">
            <h3>üè™ –í—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ:</h3>
            <input type="text" id="venue-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è" readonly>
            <input type="text" id="venue-lat" placeholder="–®–∏—Ä–æ—Ç–∞ –∑–∞–≤–µ–¥–µ–Ω–∏—è" readonly>
            <input type="text" id="venue-lng" placeholder="–î–æ–ª–≥–æ—Ç–∞ –∑–∞–≤–µ–¥–µ–Ω–∏—è" readonly>
        </div>

        <div class="info">
            <h3>üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</h3>
            <input type="text" id="distance" placeholder="–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–º)" readonly>
            <span>–º–µ—Ç—Ä–æ–≤</span>
        </div>

        <div class="log" id="log">
            <strong>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</strong><br>
            <div id="log-content"></div>
        </div>
    </div>

    <script>
        let myMap, myPlacemark;
        let currentLocation = null;
        let venueLocation = null;

        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `[${timestamp}] ${message}<br>`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ –ø–æ —Ñ–æ—Ä–º—É–ª–µ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–∞
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö
            return Math.round(distance);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π
        function updateFields() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (currentLocation) {
                document.getElementById('user-lat').value = currentLocation.lat.toFixed(6);
                document.getElementById('user-lng').value = currentLocation.lng.toFixed(6);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –∑–∞–≤–µ–¥–µ–Ω–∏—è
            if (venueLocation) {
                document.getElementById('venue-lat').value = venueLocation.lat.toFixed(6);
                document.getElementById('venue-lng').value = venueLocation.lng.toFixed(6);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
            if (currentLocation && venueLocation) {
                const distance = calculateDistance(
                    currentLocation.lat, 
                    currentLocation.lng, 
                    venueLocation.lat, 
                    venueLocation.lng
                );
                document.getElementById('distance').value = distance;
                log(`üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ: ${distance} –º–µ—Ç—Ä–æ–≤`);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –±–∞–ª—É–Ω–∞
        function extractNameFromBalloon() {
            try {
                log('üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ –±–∞–ª—É–Ω–∞...');
                
                // –ò—â–µ–º –±–∞–ª—É–Ω –ø–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–º —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º
                let balloonContent = document.querySelector('.ymaps-2-1-79-balloon');
                if (!balloonContent) {
                    balloonContent = document.querySelector('.ymaps-balloon');
                }
                if (!balloonContent) {
                    balloonContent = document.querySelector('.balloon');
                }
                if (!balloonContent) {
                    balloonContent = document.querySelector('[class*="balloon"]');
                }
                if (!balloonContent) {
                    balloonContent = document.querySelector('[class*="ymaps"]');
                }
                
                if (!balloonContent) {
                    log('‚ùå –ë–∞–ª—É–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return null;
                }
                
                log('‚úÖ –ë–∞–ª—É–Ω –Ω–∞–π–¥–µ–Ω: ' + balloonContent.className);
                
                // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                const headers = balloonContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
                log('üìã –ù–∞–π–¥–µ–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: ' + headers.length);
                
                for (let header of headers) {
                    const headerText = header.textContent.trim();
                    log(`üìã –ó–∞–≥–æ–ª–æ–≤–æ–∫: "${headerText}"`);
                    
                    if (headerText && headerText.length > 2) {
                        log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ: "${headerText}"`);
                        return { name: headerText, links: [headerText] };
                    }
                }
                
                log('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                return null;
                
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ: ' + error);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –±–∞–ª—É–Ω–∞ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—è –∑–∞–≤–µ–¥–µ–Ω–∏—è
        function parseBalloonAndFillVenue() {
            log('=== –ü–ê–†–°–ò–ù–ì –ë–ê–õ–£–ù–ê ===');
            
            const result = extractNameFromBalloon();
            
            if (result && result.name) {
                document.getElementById('venue-name').value = result.name;
                log('‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–æ: ' + result.name);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –ø–æ–ª—è
                updateFields();
            } else {
                log('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            }
            
            log('=====================');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π
        function addTestVenues() {
            const testVenues = [
                {
                    name: '–ö–∞—Ñ–µ "–£—é—Ç–Ω–æ–µ"',
                    coords: [55.7558, 37.6176],
                    description: '–£—é—Ç–Ω–æ–µ –∫–∞—Ñ–µ –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞'
                },
                {
                    name: '–†–µ—Å—Ç–æ—Ä–∞–Ω "–í–∫—É—Å–Ω–æ"',
                    coords: [55.7539, 37.6208],
                    description: '–†–µ—Å—Ç–æ—Ä–∞–Ω —Å –æ—Ç–ª–∏—á–Ω–æ–π –∫—É—Ö–Ω–µ–π'
                },
                {
                    name: '–ö–æ—Ñ–µ–π–Ω—è "–ê—Ä–æ–º–∞—Ç"',
                    coords: [55.7578, 37.6156],
                    description: '–ö–æ—Ñ–µ–π–Ω—è —Å –∞—Ä–æ–º–∞—Ç–Ω—ã–º –∫–æ—Ñ–µ'
                }
            ];

            testVenues.forEach(function(venue) {
                const placemark = new ymaps.Placemark(venue.coords, {
                    balloonContent: `
                        <div style="padding: 10px;">
                            <h3 style="margin: 0 0 10px 0; color: #333;">${venue.name}</h3>
                            <p style="margin: 0; color: #666;">${venue.description}</p>
                            <p style="margin: 10px 0 0 0; color: #999; font-size: 12px;">
                                <strong>–ê–¥—Ä–µ—Å:</strong> —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 1<br>
                                <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> +7 (999) 123-45-67<br>
                                <strong>–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</strong> 9:00 - 23:00
                            </p>
                        </div>
                    `
                }, {
                    preset: 'islands#redDotIcon',
                    balloonAutoPan: true
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∑–∞–≤–µ–¥–µ–Ω–∏–µ
                placemark.events.add('click', function(e) {
                    log('üñ±Ô∏è –ö–ª–∏–∫ –Ω–∞ –∑–∞–≤–µ–¥–µ–Ω–∏–µ: ' + venue.name);
                    venueLocation = { lat: venue.coords[0], lng: venue.coords[1] };
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–ª—É–Ω
                    placemark.balloon.open();
                });

                myMap.geoObjects.add(placemark);
            });

            log('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞ –∫–∞—Ä—Ç—É');
        }

        function initMap() {
            ymaps.ready(function () {
                myMap = new ymaps.Map('map', {
                    center: [55.76, 37.64], // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    zoom: 12,
                    controls: ['zoomControl', 'fullscreenControl']
                });

                myMap.events.add('click', function (e) {
                    var coords = e.get('coords');
                    setLocation(coords[0], coords[1]);
                });

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç—É
                addTestVenues();

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–ª—É–Ω–æ–≤
                myMap.events.add('balloonopen', function (e) {
                    log('üéà –ë–∞–ª—É–Ω –æ—Ç–∫—Ä—ã—Ç, –Ω–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥...');
                    const coords = e.get('coords');
                    log('üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –±–∞–ª—É–Ω–∞: ' + coords[0] + ', ' + coords[1]);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª—É–Ω–∞
                    setTimeout(function() {
                        parseBalloonAndFillVenue();
                    }, 500);
                });

                log('‚úÖ –ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            });
        }

        function setLocation(lat, lng) {
            currentLocation = {lat: lat, lng: lng};
            log('üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ' + lat.toFixed(6) + ', ' + lng.toFixed(6));

            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –º–µ—Ç–∫—É
            if (myPlacemark) {
                myMap.geoObjects.remove(myPlacemark);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
            myPlacemark = new ymaps.Placemark([lat, lng], {
                balloonContent: '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
            }, {
                preset: 'islands#blueDotIcon'
            });

            myMap.geoObjects.add(myPlacemark);
            myMap.setCenter([lat, lng], 15);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è
            updateFields();
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                log('üìç –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...');
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        var lat = position.coords.latitude;
                        var lng = position.coords.longitude;
                        setLocation(lat, lng);
                    },
                    function(error) {
                        log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è: ' + error.message);
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É.');
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 5000,
                        maximumAge: 300000
                    }
                );
            } else {
                log('‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É.');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É...');
            initMap();
        };
    </script>
</body>
</html> 