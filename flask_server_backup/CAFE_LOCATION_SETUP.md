# Защита от "диванных посетителей" - Настройка и логика

## Обзор системы защиты

Система защиты от "диванных посетителей" предотвращает регистрацию пользователей, которые не находятся физически рядом с выбранным кафе. Это обеспечивает подлинность знакомств и безопасность платформы.

## Основные компоненты

### 1. Константа максимального расстояния
```python
MAX_DISTANCE_TO_CAFE = 100  # Максимальное расстояние до кафе в метрах
```
- **Расположение**: строка 25 в `app.py`
- **Назначение**: Определяет максимально допустимое расстояние между пользователем и кафе
- **Изменение**: Может быть изменена вручную для настройки строгости проверки

### 2. Функция расчета расстояния
```python
def calculate_distance(lat1, lon1, lat2, lon2):
    """Рассчитывает расстояние между двумя точками на поверхности Земли"""
```
- **Алгоритм**: Формула гаверсинуса для точного расчета расстояния на сфере
- **Точность**: Учитывает кривизну Земли
- **Единицы**: Метры

### 3. Функция проверки близости
```python
def is_near_cafe(user_lat, user_lon, cafe_lat, cafe_lon, max_distance=MAX_DISTANCE_TO_CAFE):
    """Проверяет, находится ли пользователь рядом с кафе"""
```
- **Возвращает**: `(is_near, distance)` - булево значение и точное расстояние
- **Логика**: Сравнивает фактическое расстояние с максимально допустимым

## Логика работы защиты

### Клиентская проверка (JavaScript)
1. **Выбор кафе**: При клике на метку кафе автоматически заполняются поля
2. **Проверка расстояния**: Вызывается API `/api/check-distance`
3. **Визуальная обратная связь**: Показываются уведомления о расстоянии
4. **Блокировка формы**: Кнопка отправки блокируется при превышении расстояния

### Серверная проверка (Python)
1. **Получение координат**: Извлекаются координаты пользователя и кафе из формы
2. **Расчет расстояния**: Используется формула гаверсинуса
3. **Проверка условия**: Сравнение с `MAX_DISTANCE_TO_CAFE`
4. **Блокировка регистрации**: Возвращается страница ошибки при превышении лимита

## API Endpoint

### `/api/check-distance`
- **Метод**: POST
- **Назначение**: Проверка расстояния между пользователем и кафе
- **Параметры**:
  - `user_lat`, `user_lon` - координаты пользователя
  - `cafe_lat`, `cafe_lon` - координаты кафе
- **Ответ**:
  ```json
  {
    "distance": 85.5,
    "is_near": true,
    "max_distance": 100
  }
  ```

## Пользовательский интерфейс

### Уведомления
- **Зеленое уведомление**: Пользователь находится в допустимом радиусе
- **Красное уведомление**: Расстояние превышает лимит
- **Автоскрытие**: Уведомления исчезают через 5 секунд

### Страница ошибки
При попытке регистрации с превышением расстояния показывается:
- Точное расстояние до кафе
- Максимально допустимое расстояние
- Название выбранного кафе
- Кнопка возврата к регистрации

## Настройка системы

### Изменение радиуса действия
1. Откройте файл `app.py`
2. Найдите строку 25: `MAX_DISTANCE_TO_CAFE = 100`
3. Измените значение на желаемое (в метрах)
4. Перезапустите сервер

### Рекомендуемые значения
- **50 метров**: Строгая проверка (только посетители внутри кафе)
- **100 метров**: Стандартная проверка (включая близлежащие зоны)
- **200 метров**: Мягкая проверка (для больших торговых центров)

## Безопасность

### Защита от обхода
1. **Клиентская проверка**: Предотвращает отправку формы
2. **Серверная проверка**: Финальная проверка перед сохранением
3. **Валидация координат**: Проверка корректности данных

### Ограничения
- Требуется доступ к геолокации браузера
- Зависит от точности GPS устройства
- Не работает при отключенном JavaScript

## Отладка

### Проверка работы
1. Откройте консоль браузера (F12)
2. Выберите кафе на карте
3. Проверьте логи:
   - `✅ Расстояние до кафе: Xм - OK` (успех)
   - `❌ Расстояние до кафе: Xм - СЛИШКОМ ДАЛЕКО` (блокировка)

### Частые проблемы
- **"Сначала определите ваше местоположение"**: Разрешите доступ к геолокации
- **"Ошибка проверки расстояния"**: Проверьте подключение к интернету
- **Неточные координаты**: Убедитесь в точности GPS устройства

## Технические детали

### Формула гаверсинуса
```python
R = 6371000  # Радиус Земли в метрах
a = sin²(Δφ/2) + cos(φ₁) × cos(φ₂) × sin²(Δλ/2)
c = 2 × atan2(√a, √(1−a))
distance = R × c
```

### Координаты
- **Формат**: Десятичные градусы (WGS84)
- **Точность**: До 6 знаков после запятой
- **Пример**: 55.7558, 37.6176 (Москва)

## Заключение

Система защиты от "диванных посетителей" обеспечивает:
- ✅ Подлинность пользователей
- ✅ Безопасность платформы
- ✅ Удобство настройки
- ✅ Надежность проверки

Система работает автоматически и не требует дополнительной настройки после установки. 