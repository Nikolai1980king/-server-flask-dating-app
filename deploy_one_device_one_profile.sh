#!/bin/bash

echo "ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ 'ÐžÐ´Ð½Ð¾ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ = Ð¾Ð´Ð½Ð° Ð°Ð½ÐºÐµÑ‚Ð°'"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
if [ "$EUID" -eq 0 ]; then
    echo "âŒ ÐÐµ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ð¹Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ñ‚ root Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ"
    exit 1
fi

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
sudo systemctl stop dating-app 2>/dev/null || true
pkill -f "python.*app.py" 2>/dev/null || true

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ (ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ git)
if [ -d ".git" ]; then
    echo "ðŸ“¥ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· git..."
    git pull origin main
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
pip install -r requirements.txt

# Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "ðŸ—„ï¸ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
python init_db_simple.py

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ
echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ..."
sudo tee /etc/systemd/system/dating-app.service > /dev/null <<EOF
[Unit]
Description=Dating App - One Device One Profile
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=$(pwd)
ExecStart=$(which python3) $(pwd)/run_production.py
Restart=always
RestartSec=10
Environment=PORT=80
Environment=HOST=0.0.0.0

[Install]
WantedBy=multi-user.target
EOF

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²Ð¸Ñ
echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd..."
sudo systemctl daemon-reload

echo "âœ… Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº..."
sudo systemctl enable dating-app

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
sudo systemctl start dating-app

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ..."
sleep 3
sudo systemctl status dating-app --no-pager -l

echo "ðŸŒ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 80"
echo "ðŸ“± Ð”Ð¾Ð¼ÐµÐ½: ÑÑ‚ÑƒÑ‚Ð°.Ñ€Ñ„"
echo "ðŸŽ¯ Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° 'ÐžÐ´Ð½Ð¾ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ = Ð¾Ð´Ð½Ð° Ð°Ð½ÐºÐµÑ‚Ð°':"
echo "   â€¢ Ð£ÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ÑÑ Ð¿Ð¾ IP-Ð°Ð´Ñ€ÐµÑÑƒ"
echo "   â€¢ ÐžÐ´Ð½Ð¾ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ = Ð¾Ð´Ð½Ð° Ð°Ð½ÐºÐµÑ‚Ð°"
echo "   â€¢ ÐŸÑ€Ð¸ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐµ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð°Ð½ÐºÐµÑ‚Ñƒ Ð² Ð´Ñ€ÑƒÐ³Ð¾Ð¼ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ"
echo "     â†’ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð°Ð½ÐºÐµÑ‚Ñƒ"
echo ""
echo "ðŸ“‹ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "  sudo systemctl status dating-app    - ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
echo "  sudo systemctl restart dating-app   - Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
echo "  sudo journalctl -u dating-app -f   - Ð»Ð¾Ð³Ð¸ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸"
echo "  sudo systemctl stop dating-app      - Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°"
echo ""
echo "ðŸ” ÐžÑ‚Ð»Ð°Ð´ÐºÐ°:"
echo "  http://ÑÑ‚ÑƒÑ‚Ð°.Ñ€Ñ„/debug_redirect.html"
echo ""
echo "ðŸ“Š Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°:"
echo "  http://ÑÑ‚ÑƒÑ‚Ð°.Ñ€Ñ„/check_ip_control"
echo "  http://ÑÑ‚ÑƒÑ‚Ð°.Ñ€Ñ„/check_ip"
echo ""
echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:"
echo "  1. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð°Ð½ÐºÐµÑ‚Ñƒ Ð² Chrome"
echo "  2. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Firefox Ð½Ð° Ñ‚Ð¾Ð¼ Ð¶Ðµ ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€Ðµ"
echo "  3. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð°Ð½ÐºÐµÑ‚Ñƒ"
echo "  4. Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð¾Ð¹Ñ‚Ð¸ Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð° Ð°Ð½ÐºÐµÑ‚Ñƒ Ð¸Ð· Chrome"
echo ""
echo "ðŸ“± Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¸:"
echo "  â€¢ Chrome â†’ Firefox: Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ âœ…"
echo "  â€¢ Firefox â†’ Safari: Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ âœ…"
echo "  â€¢ ÐšÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€ â†’ Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð°Ð½ÐºÐµÑ‚Ñ‹ âœ…"