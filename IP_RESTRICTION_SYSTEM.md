# üåê –°–∏—Å—Ç–µ–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ IP-–∞–¥—Ä–µ—Å—É

## ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

–°–∏—Å—Ç–µ–º–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ —Å –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ IP-–∞–¥—Ä–µ—Å—É –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

## üéØ –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ IP-–∞–¥—Ä–µ—Å–∞
- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
- –£—á–∏—Ç—ã–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–æ–∫—Å–∏ (X-Forwarded-For, X-Real-IP)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç request.remote_addr –∫–∞–∫ fallback

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç IP-–∞–¥—Ä–µ—Å
- –ï—Å–ª–∏ —Å —ç—Ç–æ–≥–æ IP —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ –∞–Ω–∫–µ—Ç–∞ - –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ
- –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å

### 3. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è IP
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–∫–µ—Ç—ã IP —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- IP –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É –ø—Ä–æ—Ñ–∏–ª—é

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ Device
```sql
CREATE TABLE device (
    id INTEGER PRIMARY KEY,
    device_fingerprint VARCHAR UNIQUE NOT NULL,
    client_ip VARCHAR NOT NULL,  -- –ù–û–í–û–ï –ü–û–õ–ï
    user_agent VARCHAR,
    screen_resolution VARCHAR,
    timezone VARCHAR,
    language VARCHAR,
    platform VARCHAR,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_used DATETIME DEFAULT CURRENT_TIMESTAMP,
    profile_id VARCHAR
);
```

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è IP (—Å—Ç—Ä–æ–∫–∏ 216-226)
```python
def get_client_ip(request):
    """–ü–æ–ª—É—á–∞–µ—Ç IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞ —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–∫—Å–∏"""
    if request.headers.get('X-Forwarded-For'):
        ip = request.headers.get('X-Forwarded-For').split(',')[0].strip()
    elif request.headers.get('X-Real-IP'):
        ip = request.headers.get('X-Real-IP')
    else:
        ip = request.remote_addr
    return ip
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (—Å—Ç—Ä–æ–∫–∏ 245-265)
```python
def check_device_restriction(device_fingerprint, client_ip):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–Ω–∫–µ—Ç–∞ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ IP –∏–ª–∏ –æ—Ç–ø–µ—á–∞—Ç–∫–∞"""
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ IP-–∞–¥—Ä–µ—Å—É (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
    device_by_ip = Device.query.filter_by(client_ip=client_ip).first()
    
    if device_by_ip and device_by_ip.profile_id:
        profile = Profile.query.get(device_by_ip.profile_id)
        if profile:
            return True, device_by_ip.profile_id
    
    # –ï—Å–ª–∏ –ø–æ IP –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –æ—Ç–ø–µ—á–∞—Ç–∫—É
    device_by_fingerprint = Device.query.filter_by(device_fingerprint=device_fingerprint).first()
    
    if device_by_fingerprint and device_by_fingerprint.profile_id:
        profile = Profile.query.get(device_by_fingerprint.profile_id)
        if profile:
            return True, device_by_fingerprint.profile_id
    
    return False, None
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ create_profile() (—Å—Ç—Ä–æ–∫–∏ 1221-1239)
```python
# –°–æ–∑–¥–∞–µ–º –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –ø–æ–ª—É—á–∞–µ–º IP
device_fingerprint, client_ip = create_device_fingerprint(request)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É (–ø–æ IP –∏ –æ—Ç–ø–µ—á–∞—Ç–∫—É)
has_existing_profile, existing_profile_id = check_device_restriction(device_fingerprint, client_ip)

if has_existing_profile:
    return jsonify({
        'success': False,
        'error': f'–° —ç—Ç–æ–≥–æ IP-–∞–¥—Ä–µ—Å–∞ ({client_ip}) —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞ –∞–Ω–∫–µ—Ç–∞. –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–Ω–∞ –∞–Ω–∫–µ—Ç–∞.',
        'has_active_profile': True,
        'redirect_url': url_for('view_profile', id=existing_profile_id)
    }), 400
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ —Å IP:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ `/create`
   - –°–æ–∑–¥–∞–µ—Ç –∞–Ω–∫–µ—Ç—É —É—Å–ø–µ—à–Ω–æ
   - IP —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –±–∞–∑–µ

2. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ —Å —Ç–æ–≥–æ –∂–µ IP:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ `/create` —Å–Ω–æ–≤–∞
   - –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞–Ω–∫–µ—Ç—É –ø–æ IP
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å

3. **–í—Ö–æ–¥ —Å –¥—Ä—É–≥–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ —Ç–æ–º –∂–µ IP:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä
   - –ü—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É
   - –°–∏—Å—Ç–µ–º–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ (IP —Ç–æ—Ç –∂–µ)

4. **–í—Ö–æ–¥ —Å –¥—Ä—É–≥–æ–≥–æ IP:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç —Å –¥—Ä—É–≥–æ–≥–æ IP
   - –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∞–Ω–∫–µ—Ç—É

## üéâ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ IP-–∫–æ–Ω—Ç—Ä–æ–ª—è

‚úÖ **–ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ:** IP-–∞–¥—Ä–µ—Å —Å–ª–æ–∂–Ω–µ–µ –ø–æ–¥–¥–µ–ª–∞—Ç—å —á–µ–º –æ—Ç–ø–µ—á–∞—Ç–æ–∫ –±—Ä–∞—É–∑–µ—Ä–∞
‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏:** –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç User-Agent
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –õ–µ–≥—á–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å
‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–Ω–∫–µ—Ç

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:**
   ```bash
   python app.py
   ```

2. **–û—Ç–∫—Ä–æ–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É:**
   ```
   http://localhost:5000/test_device_restriction_system.html
   ```

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã:**
   ```
   http://localhost:5000/create
   ```

4. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É —Å–Ω–æ–≤–∞** - —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/api/device-stats` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É `device` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç IP-–∞–¥—Ä–µ—Å–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- **NAT/–ü—Ä–æ–∫—Å–∏:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞ –æ–¥–Ω–∏–º NAT –±—É–¥—É—Ç —Å—á–∏—Ç–∞—Ç—å—Å—è –æ–¥–Ω–∏–º IP
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ IP:** –ü—Ä–∏ —Å–º–µ–Ω–µ IP –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∞–Ω–∫–µ—Ç—É
- **VPN/–ü—Ä–æ–∫—Å–∏:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å VPN –±—É–¥—É—Ç –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–µ IP