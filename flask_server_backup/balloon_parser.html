<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üéà –ü–∞—Ä—Å–µ—Ä –±–∞–ª—É–Ω–æ–≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=9a3beffb-a8a0-4d55-850f-d258dd28c104&lang=ru_RU" type="text/javascript"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
            background-size: 400% 400%;
            animation: starryNight 15s ease infinite;
            color: white;
            min-height: 100vh;
        }

        @keyframes starryNight {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .map-container {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 15px;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(90deg, #4CAF50 0%, #81c784 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn:hover {
            box-shadow: 0 4px 16px rgba(76,175,80,0.3);
            transform: translateY(-2px);
        }

        .btn-blue {
            background: linear-gradient(90deg, #2196F3 0%, #64B5F6 100%);
        }

        .btn-blue:hover {
            box-shadow: 0 4px 16px rgba(33,150,243,0.3);
        }

        .btn-orange {
            background: linear-gradient(90deg, #FF9800 0%, #FFB74D 100%);
        }

        .btn-orange:hover {
            box-shadow: 0 4px 16px rgba(255,152,0,0.3);
        }

        .btn-red {
            background: linear-gradient(90deg, #f44336 0%, #e57373 100%);
        }

        .btn-red:hover {
            box-shadow: 0 4px 16px rgba(244,67,54,0.3);
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            color: #333;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            color: #333;
            border-left: 4px solid #4CAF50;
        }

        .info-card h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
            font-size: 1.1em;
        }

        .info-card p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .venue-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: #333;
            font-size: 1.1em;
            font-weight: bold;
        }

        .status-bar {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            color: #fff;
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            color: #fff;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .log-success {
            background: rgba(76, 175, 80, 0.2);
            border-left: 3px solid #4CAF50;
        }

        .log-error {
            background: rgba(244, 67, 54, 0.2);
            border-left: 3px solid #f44336;
        }

        .log-info {
            background: rgba(33, 150, 243, 0.2);
            border-left: 3px solid #2196F3;
        }

        .log-warning {
            background: rgba(255, 152, 0, 0.2);
            border-left: 3px solid #FF9800;
        }

        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            z-index: 1000;
            animation: fadeInOut 3s forwards;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        @keyframes fadeInOut {
            0% { opacity: 0; top: 0; }
            10% { opacity: 1; top: 80px; }
            90% { opacity: 1; top: 80px; }
            100% { opacity: 0; top: 0; }
        }

        .extracted-data {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            color: #fff;
        }

        .data-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .data-label {
            font-weight: bold;
            color: #64B5F6;
        }

        .data-value {
            color: #fff;
            max-width: 60%;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéà –ü–∞—Ä—Å–µ—Ä –±–∞–ª—É–Ω–æ–≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç</h1>
        
        <div class="status-bar">
            <strong>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
            1. –ù–∞ –∫–∞—Ä—Ç–µ –Ω–∞–π–¥–∏—Ç–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ (–∫–∞—Ñ–µ, —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –±–∞—Ä)<br>
            2. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è - –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –±–∞–ª—É–Ω<br>
            3. –ù–∞–∂–º–∏—Ç–µ "üéØ –ò–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–ª—É–Ω–∞"<br>
            4. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á–µ—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ñ–∞–π–ª<br>
            5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∏–∂–µ
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>

        <div class="controls">
            <button type="button" class="btn btn-blue" onclick="extractFromActiveBalloon()">
                üéØ –ò–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–ª—É–Ω–∞
            </button>
            <button type="button" class="btn btn-orange" onclick="createTestVenues()">
                üè™ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è
            </button>
            <button type="button" class="btn" onclick="clearMap()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É
            </button>
            <button type="button" class="btn btn-red" onclick="clearLog()">
                üìù –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
            </button>
        </div>

        <input type="text" name="venue" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è (–∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)" id="venue-input" class="venue-input" readonly>

        <div class="extracted-data" id="extracted-data" style="display: none;">
            <h3>üìä –ò–∑–≤–ª–µ—á–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
            <div id="data-content"></div>
        </div>

        <div class="log-container">
            <strong>üìù –õ–æ–≥ –æ–ø–µ—Ä–∞—Ü–∏–π:</strong>
            <div id="log"></div>
        </div>
    </div>

    <script>
        let myMap;
        let testVenues = [];
        let extractedInfo = null;

        function initMap() {
            ymaps.ready(function () {
                myMap = new ymaps.Map('map', {
                    center: [55.7558, 37.6176], // –ú–æ—Å–∫–≤–∞
                    zoom: 15,
                    controls: ['zoomControl', 'fullscreenControl', 'searchControl']
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –±–∞–ª—É–Ω–∞
                myMap.events.add('balloonopen', function(e) {
                    addLog('üéà –ë–∞–ª—É–Ω –æ—Ç–∫—Ä—ã—Ç', 'info');
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º geoObject –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –±–∞–ª—É–Ω–∞
                    try {
                        const balloonData = myMap.balloon.getData();
                        if (balloonData && balloonData.geoObject) {
                            window.lastClickedGeoObject = balloonData.geoObject;
                            addLog('üìç –°–æ—Ö—Ä–∞–Ω–µ–Ω geoObject –∏–∑ –±–∞–ª—É–Ω–∞', 'info');
                        }
                    } catch (e) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å geoObject:', e);
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –±–∞–ª—É–Ω–∞
                myMap.events.add('balloonclose', function(e) {
                    addLog('üéà –ë–∞–ª—É–Ω –∑–∞–∫—Ä—ã—Ç', 'info');
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–ª–∏–∫–Ω—É—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
                myMap.events.add('click', function (e) {
                    const clickedObject = e.get('target');
                    if (clickedObject && clickedObject.geoObjects) {
                        const geoObjects = clickedObject.geoObjects.getAll();
                        if (geoObjects.length > 0) {
                            window.lastClickedGeoObject = geoObjects[0];
                            addLog('üìç –°–æ—Ö—Ä–∞–Ω–µ–Ω –∫–ª–∏–∫–Ω—É—Ç—ã–π –æ–±—ä–µ–∫—Ç', 'info');
                        }
                    }
                });

                addLog('üó∫Ô∏è –ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'success');
            });
        }

        function extractFromActiveBalloon() {
            addLog('üîç –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞–ª—É–Ω–∞...', 'info');
            
            if (!myMap.balloon || !myMap.balloon.isOpen()) {
                showNotification('‚ùå –ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –±–∞–ª—É–Ω–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è!');
                addLog('‚ùå –ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –±–∞–ª—É–Ω–∞', 'error');
                return;
            }

            try {
                // –ú–µ—Ç–æ–¥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–∞–ª—É–Ω–∞ (—Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è)
                const balloonData = myMap.balloon.getData();
                addLog('üìã –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –±–∞–ª—É–Ω–∞', 'success');

                // –ú–µ—Ç–æ–¥ 2: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä)
                const htmlContent = extractHTMLContent();
                addLog('üåê –ò–∑–≤–ª–µ—á–µ–Ω HTML –∫–æ–Ω—Ç–µ–Ω—Ç', 'success');

                // –ú–µ—Ç–æ–¥ 3: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ geoObject (—Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è)
                const geoObjectData = extractGeoObjectData();
                addLog('üìç –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ geoObject', 'success');

                // –ú–µ—Ç–æ–¥ 4: –ï—Å–ª–∏ geoObject –ø—É—Å—Ç–æ–π, –ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ HTML
                if (!geoObjectData.name || geoObjectData.name === '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ') {
                    addLog('üîÑ geoObject –ø—É—Å—Ç–æ–π, –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞', 'info');
                    const htmlExtractedData = extractDataFromHTML(htmlContent);
                    if (htmlExtractedData.name && htmlExtractedData.name !== '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ') {
                        addLog('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏–∑ HTML', 'success');
                        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        Object.assign(geoObjectData, htmlExtractedData);
                    }
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                sendDataToServer(geoObjectData, balloonData, htmlContent);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏:', error);
                addLog(`‚ùå –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è: ${error.message}`, 'error');
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
            }
        }

        function extractHTMLContent() {
            try {
                let fullHTML = '';
                
                // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –≤–µ—Å—å –±–∞–ª—É–Ω —Ü–µ–ª–∏–∫–æ–º (—ç—Ç–æ –¥–∞—Å—Ç –Ω–∞–º –ø–æ–ª–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É)
                const balloonSelectors = [
                    '.ymaps-2-1-79-balloon',
                    '.ymaps-balloon',
                    '.balloon',
                    '.ymaps-2-1-79-balloon__layout',
                    '.ymaps-balloon__layout',
                    '.balloon-layout',
                    '.balloon__layout'
                ];
                
                for (let selector of balloonSelectors) {
                    try {
                        const balloon = document.querySelector(selector);
                        if (balloon && balloon.innerHTML) {
                            addLog(`üéà –í–µ—Å—å –±–∞–ª—É–Ω –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä: ${selector}`, 'info');
                            addLog(`üìè –†–∞–∑–º–µ—Ä –≤—Å–µ–≥–æ –±–∞–ª—É–Ω–∞: ${balloon.innerHTML.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
                            fullHTML = balloon.innerHTML;
                            break;
                        }
                    } catch (e) {
                        console.warn(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –±–∞–ª—É–Ω–∞ ${selector}:`, e);
                        continue;
                    }
                }
                
                // 2. –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤–µ—Å—å –±–∞–ª—É–Ω, –ø—Ä–æ–±—É–µ–º —Å–æ–±—Ä–∞—Ç—å –ø–æ —á–∞—Å—Ç—è–º
                if (!fullHTML) {
                    // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫/—à–∞–ø–∫—É –±–∞–ª—É–Ω–∞
                    const headerSelectors = [
                        '.ymaps-2-1-79-balloon__header',
                        '.ymaps-balloon__header',
                        '.balloon-header',
                        '.balloon__header',
                        '.ymaps-2-1-79-balloon__title',
                        '.ymaps-balloon__title',
                        '.balloon-title',
                        '.balloon__title',
                        '.ymaps-2-1-79-balloon__header-content',
                        '.ymaps-balloon__header-content',
                        '.balloon-header-content',
                        '.balloon__header-content'
                    ];
                    
                    for (let selector of headerSelectors) {
                        try {
                            const header = document.querySelector(selector);
                            if (header && header.innerHTML) {
                                addLog(`üéØ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–∞–ª—É–Ω–∞ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä: ${selector}`, 'info');
                                addLog(`üìè –†–∞–∑–º–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞: ${header.innerHTML.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
                                fullHTML += `<div class="balloon-header">${header.innerHTML}</div>`;
                                break;
                            }
                        } catch (e) {
                            console.warn(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ ${selector}:`, e);
                            continue;
                        }
                    }
                    
                    // –ó–∞—Ç–µ–º –∏—â–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –±–∞–ª—É–Ω–∞
                    const contentSelectors = [
                        '.ymaps-2-1-79-balloon__content',
                        '.ymaps-balloon__content',
                        '.balloon-content',
                        '.balloon__content',
                        '.ymaps-2-1-79-balloon__content-body',
                        '.ymaps-2-1-79-balloon__content-body__content',
                        '.ymaps-2-1-79-balloon__content-body__content__content',
                        '.ymaps-2-1-79-balloon__content-body__content__content__content'
                    ];
                    
                    for (let selector of contentSelectors) {
                        try {
                            const content = document.querySelector(selector);
                            if (content && content.innerHTML) {
                                addLog(`üåê HTML –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä: ${selector}`, 'info');
                                addLog(`üìè –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞: ${content.innerHTML.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
                                fullHTML += `<div class="balloon-content">${content.innerHTML}</div>`;
                                break;
                            }
                        } catch (e) {
                            console.warn(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ ${selector}:`, e);
                            continue;
                        }
                    }
                }
                
                // 4. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ overlay
                if (!fullHTML) {
                    try {
                        if (myMap.balloon && myMap.balloon.isOpen()) {
                            const balloonElement = myMap.balloon.getData().geoObject;
                            if (balloonElement && balloonElement.getOverlay) {
                                const overlay = balloonElement.getOverlay();
                                if (overlay && overlay.getData) {
                                    const balloonContent = overlay.getData();
                                    if (balloonContent && balloonContent.innerHTML) {
                                        addLog('üåê HTML –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ overlay', 'info');
                                        fullHTML = balloonContent.innerHTML;
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —á–µ—Ä–µ–∑ overlay:', e);
                    }
                }
                
                if (fullHTML) {
                    addLog(`üìè –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä HTML: ${fullHTML.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
                    return fullHTML;
                } else {
                    addLog('‚ö†Ô∏è HTML –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
                    return '';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞:', error);
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞: ${error.message}`, 'error');
                return '';
            }
        }

        function extractDataFromHTML(htmlContent) {
            try {
                if (!htmlContent) {
                    return {};
                }

                addLog('üîç –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞...', 'info');

                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ HTML
                addLog(`üìè –†–∞–∑–º–µ—Ä HTML –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: ${htmlContent.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
                
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContent;

                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ DOM
                const allElements = tempDiv.querySelectorAll('*');
                addLog(`üîç –ù–∞–π–¥–µ–Ω–æ ${allElements.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ HTML`, 'info');
                
                // –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                for (let i = 0; i < Math.min(10, allElements.length); i++) {
                    const element = allElements[i];
                    const text = element.textContent.trim();
                    if (text && text.length > 0) {
                        addLog(`üîç –≠–ª–µ–º–µ–Ω—Ç ${i+1}: ${element.tagName} "${text.substring(0, 50)}"`, 'info');
                    }
                }

                const extractedData = {
                    name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ',
                    address: '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω',
                    phone: '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω',
                    website: '–°–∞–π—Ç –Ω–µ —É–∫–∞–∑–∞–Ω',
                    hours: '–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã',
                    rating: '–†–µ–π—Ç–∏–Ω–≥ –Ω–µ —É–∫–∞–∑–∞–Ω',
                    reviews_count: '–û—Ç–∑—ã–≤—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã',
                    description: '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'
                };

                        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        const nameSelectors = [
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–∞–ª—É–Ω–∞
            '.balloon-header', '.balloon__header', '.ymaps-balloon__header', '.ymaps-2-1-79-balloon__header',
            '.balloon-title', '.balloon__title', '.ymaps-balloon__title', '.ymaps-2-1-79-balloon__title',
            '.balloon-header-content', '.balloon__header-content', '.ymaps-balloon__header-content', '.ymaps-2-1-79-balloon__header-content',
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –û–±—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            'h1', 'h2', 'h3', '.name', '.title', '.venue-name', '.place-name',
            '[class*="name"]', '[class*="title"]', '[class*="venue"]',
            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ó–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ
            '.balloon-content h1', '.balloon-content h2', '.balloon-content h3',
            '.balloon__content h1', '.balloon__content h2', '.balloon__content h3',
            '.ymaps-balloon__content h1', '.ymaps-balloon__content h2', '.ymaps-balloon__content h3',
            '.ymaps-2-1-79-balloon__content h1', '.ymaps-2-1-79-balloon__content h2', '.ymaps-2-1-79-balloon__content h3'
        ];
        
        let nameFound = false;
        for (let selector of nameSelectors) {
            const element = tempDiv.querySelector(selector);
            if (element && element.textContent.trim()) {
                const nameText = element.textContent.trim();
                if (nameText && nameText.length > 2 && nameText !== '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ') {
                    extractedData.name = nameText;
                    addLog(`üè™ –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑ HTML (${selector}): ${extractedData.name}`, 'info');
                    nameFound = true;
                    break;
                }
            }
        }
        
        // –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π –∑–Ω–∞—á–∏–º—ã–π —Ç–µ–∫—Å—Ç
        if (!nameFound) {
            // –ò—â–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ–º
            const allElements = tempDiv.querySelectorAll('*');
            for (let element of allElements) {
                const text = element.textContent.trim();
                if (text && text.length > 3 && text.length < 100 && 
                    !text.includes('–¢–µ–ª–µ—Ñ–æ–Ω') && !text.includes('–ê–¥—Ä–µ—Å') && 
                    !text.includes('–ß–∞—Å—ã') && !text.includes('–†–µ–π—Ç–∏–Ω–≥') &&
                    !text.includes('–û—Ç–∑—ã–≤—ã') && !text.includes('–û–ø–∏—Å–∞–Ω–∏–µ') &&
                    !text.includes('–í–µ–±-—Å–∞–π—Ç') && !text.includes('–°–∞–π—Ç') &&
                    !text.includes('https://') && !text.includes('http://') &&
                    !text.match(/^\d+$/) && !text.match(/^\d+:\d+$/) &&
                    !text.includes('–º') && !text.includes('–∫–º') &&
                    element.children.length === 0) { // –¢–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    
                    extractedData.name = text;
                    addLog(`üè™ –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –∑–Ω–∞—á–∏–º–æ–≥–æ —Ç–µ–∫—Å—Ç–∞: ${extractedData.name}`, 'info');
                    nameFound = true;
                    break;
                }
            }
        }
        
        // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ DOM
        if (!nameFound) {
            // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–∞–º–æ–º –≤–µ—Ä—Ö—É –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç
            const topElements = tempDiv.querySelectorAll('div, span, p, h1, h2, h3, h4, h5, h6');
            for (let element of topElements) {
                const text = element.textContent.trim();
                if (text && text.length > 2 && text.length < 50 &&
                    !text.includes('–¢–µ–ª–µ—Ñ–æ–Ω') && !text.includes('–ê–¥—Ä–µ—Å') &&
                    !text.includes('–ß–∞—Å—ã') && !text.includes('–†–µ–π—Ç–∏–Ω–≥')) {
                    
                    extractedData.name = text;
                    addLog(`üè™ –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –≤–µ—Ä—Ö–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞: ${extractedData.name}`, 'info');
                    break;
                }
            }
        }
        
        // –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        if (!nameFound) {
            // –ò—â–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ–º
            const textElements = [];
            for (let element of allElements) {
                const text = element.textContent.trim();
                if (text && text.length > 2 && text.length < 100 &&
                    !text.includes('–¢–µ–ª–µ—Ñ–æ–Ω') && !text.includes('–ê–¥—Ä–µ—Å') &&
                    !text.includes('–ß–∞—Å—ã') && !text.includes('–†–µ–π—Ç–∏–Ω–≥') &&
                    !text.includes('–û—Ç–∑—ã–≤—ã') && !text.includes('–û–ø–∏—Å–∞–Ω–∏–µ') &&
                    !text.includes('–í–µ–±-—Å–∞–π—Ç') && !text.includes('–°–∞–π—Ç') &&
                    !text.includes('https://') && !text.includes('http://') &&
                    !text.match(/^\d+$/) && !text.match(/^\d+:\d+$/) &&
                    !text.includes('–º') && !text.includes('–∫–º') &&
                    element.children.length === 0) {
                    textElements.push(text);
                }
            }
            
            if (textElements.length > 0) {
                extractedData.name = textElements[0];
                addLog(`üè™ –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞: ${extractedData.name}`, 'info');
            }
        }
        
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –±–∞–ª—É–Ω–∞
        if (!nameFound) {
            addLog('üîç –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞–∑–≤–∞–Ω–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –±–∞–ª—É–Ω–∞...', 'info');
            
            // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ DOM
            const headerElements = document.querySelectorAll('.ymaps-2-1-79-balloon__header, .ymaps-balloon__header, .balloon-header, .balloon__header, .ymaps-2-1-79-balloon__title, .ymaps-balloon__title, .balloon-title, .balloon__title');
            
            for (let headerElement of headerElements) {
                const headerText = headerElement.textContent.trim();
                if (headerText && headerText.length > 2 && headerText.length < 100 &&
                    !headerText.includes('–¢–µ–ª–µ—Ñ–æ–Ω') && !headerText.includes('–ê–¥—Ä–µ—Å') &&
                    !headerText.includes('–ß–∞—Å—ã') && !headerText.includes('–†–µ–π—Ç–∏–Ω–≥')) {
                    
                    extractedData.name = headerText;
                    addLog(`üè™ –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –±–∞–ª—É–Ω–∞: ${extractedData.name}`, 'info');
                    nameFound = true;
                    break;
                }
            }
        }
        
        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫ –∏–∑ –±–∞–ª—É–Ω–∞
        const balloonLinks = document.querySelectorAll('.ymaps-2-1-79-balloon a, .ymaps-balloon a, .balloon a');
        
        // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫
        const allLinkTexts = [];
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫
        balloonLinks.forEach((link, index) => {
            const linkText = link.textContent.trim();
            
            if (linkText && linkText.length > 0) {
                allLinkTexts.push(linkText);
            }
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—ã —Å—Å—ã–ª–æ–∫ –≤ extractedData
        extractedData.all_links = allLinkTexts;
        extractedData.links_count = allLinkTexts.length;
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Å—ã–ª–∫–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ
        if (allLinkTexts.length > 0) {
            extractedData.name = allLinkTexts[0];
            addLog(`üè™ –ù–∞–∑–≤–∞–Ω–∏–µ: ${extractedData.name}`, 'success');
            nameFound = true;
        } else {
            addLog('‚ö†Ô∏è –°—Å—ã–ª–∫–∏ –≤ –±–∞–ª—É–Ω–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
        }
        
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –±–∞–ª—É–Ω–∞ (–ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞)
        if (!nameFound) {
            addLog('üîç –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞–∑–≤–∞–Ω–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –±–∞–ª—É–Ω–∞...', 'info');
            
            // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≤ DOM
            const headerElements = document.querySelectorAll('.ymaps-2-1-79-balloon__header, .ymaps-balloon__header, .balloon-header, .balloon__header, .ymaps-2-1-79-balloon__title, .ymaps-balloon__title, .balloon-title, .balloon__title');
            
            addLog(`üîç –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞: ${headerElements.length}`, 'info');
            
            for (let headerElement of headerElements) {
                const headerText = headerElement.textContent.trim();
                addLog(`üìù –¢–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞: "${headerText}"`, 'info');
                
                if (headerText && headerText.length > 2 && headerText.length < 100) {
                    // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∫–∏
                    const lines = headerText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                    
                    addLog(`üìù –°—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞: ${lines.join(' | ')}`, 'info');
                    
                    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ
                    if (lines.length > 0) {
                        const firstLine = lines[0];
                        if (firstLine && firstLine.length > 2 && firstLine.length < 50 &&
                            !firstLine.includes('–†–µ—Å—Ç–æ—Ä–∞–Ω, –∫–∞—Ñ–µ, –±–∞—Ä') && !firstLine.includes('–∫–∞—Ñ–µ, –±–∞—Ä') &&
                            !firstLine.includes('–†–µ—Å—Ç–æ—Ä–∞–Ω') && !firstLine.includes('–∫–∞—Ñ–µ') && !firstLine.includes('–±–∞—Ä')) {
                            
                            extractedData.name = firstLine;
                            addLog(`üè™ –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞: ${extractedData.name}`, 'success');
                            nameFound = true;
                            break;
                        }
                    }
                }
            }
        }
        
        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞–∑–≤–∞–Ω–∏—è –≤ –ø–µ—Ä–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ –±–∞–ª—É–Ω–∞ (–µ—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω)
        if (!nameFound) {
            addLog('üîç –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞–∑–≤–∞–Ω–∏—è –≤ –ø–µ—Ä–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ –±–∞–ª—É–Ω–∞...', 'info');
            
            // –ò—â–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º –≤ –±–∞–ª—É–Ω–µ
            const balloonElements = document.querySelectorAll('.ymaps-2-1-79-balloon *, .ymaps-balloon *, .balloon *');
            for (let element of balloonElements) {
                const text = element.textContent.trim();
                if (text && text.length > 2 && text.length < 50 &&
                    !text.includes('Share') && !text.includes('–¢–µ–ª–µ—Ñ–æ–Ω') && 
                    !text.includes('–ê–¥—Ä–µ—Å') && !text.includes('–ß–∞—Å—ã') && 
                    !text.includes('–†–µ–π—Ç–∏–Ω–≥') && !text.includes('–û—Ç–∫—Ä—ã—Ç–æ') &&
                    !text.match(/^\d+[.,]\d+$/) && !text.match(/^\d+:\d+$/) &&
                    !text.includes('+7') && !text.includes('http')) {
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ —Å–ª—É–∂–µ–±–Ω—ã–π —Ç–µ–∫—Å—Ç
                    const words = text.split(/\s+/);
                    if (words.length <= 5 && words.every(word => word.length > 1)) {
                        extractedData.name = text;
                        addLog(`üè™ –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø–µ—Ä–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ –±–∞–ª—É–Ω–∞: ${extractedData.name}`, 'info');
                        nameFound = true;
                        break;
                    }
                }
            }
        }

                // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
                const addressSelectors = [
                    '.address', '.location', '[class*="address"]', '[class*="location"]',
                    'span[title*="–∞–¥—Ä–µ—Å"]', 'span[title*="address"]'
                ];
                
                for (let selector of addressSelectors) {
                    const element = tempDiv.querySelector(selector);
                    if (element && element.textContent.trim()) {
                        extractedData.address = element.textContent.trim();
                        addLog(`üè† –ê–¥—Ä–µ—Å –∏–∑ HTML: ${extractedData.address}`, 'info');
                        break;
                    }
                }

                // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                const phoneRegex = /(\+7|8)[\s\-\(]?(\d{3})[\s\-\)]?(\d{3})[\s\-]?(\d{2})[\s\-]?(\d{2})/g;
                const phoneMatch = htmlContent.match(phoneRegex);
                if (phoneMatch) {
                    extractedData.phone = phoneMatch[0];
                    addLog(`üìû –¢–µ–ª–µ—Ñ–æ–Ω –∏–∑ HTML: ${extractedData.phone}`, 'info');
                }

                // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–∞–π—Ç–∞
                const websiteRegex = /https?:\/\/[^\s<>"']+/g;
                const websiteMatch = htmlContent.match(websiteRegex);
                if (websiteMatch) {
                    // –ò—Å–∫–ª—é—á–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
                    const filteredWebsites = websiteMatch.filter(url => 
                        !url.includes('yandex.ru/maps') && 
                        !url.includes('yandex.com/maps')
                    );
                    if (filteredWebsites.length > 0) {
                        extractedData.website = filteredWebsites[0];
                        addLog(`üåê –°–∞–π—Ç –∏–∑ HTML: ${extractedData.website}`, 'info');
                    }
                }

                // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞
                const ratingRegex = /(\d+[.,]\d+|\d+)\s*(–∑–≤–µ–∑–¥|‚òÖ|‚≠ê|rating|—Ä–µ–π—Ç–∏–Ω–≥)/gi;
                const ratingMatch = htmlContent.match(ratingRegex);
                if (ratingMatch) {
                    extractedData.rating = ratingMatch[0];
                    addLog(`‚≠ê –†–µ–π—Ç–∏–Ω–≥ –∏–∑ HTML: ${extractedData.rating}`, 'info');
                }

                // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã
                const hoursRegex = /(\d{1,2}:\d{2}\s*[-‚Äî]\s*\d{1,2}:\d{2})/g;
                const hoursMatch = htmlContent.match(hoursRegex);
                if (hoursMatch) {
                    extractedData.hours = hoursMatch[0];
                    addLog(`üïê –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã –∏–∑ HTML: ${extractedData.hours}`, 'info');
                }

                addLog(`‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ ${Object.keys(extractedData).filter(k => extractedData[k] !== '–ù–µ —É–∫–∞–∑–∞–Ω' && extractedData[k] !== '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ').length} –ø–æ–ª–µ–π –∏–∑ HTML`, 'success');
                
                return extractedData;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ HTML:', error);
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ HTML: ${error.message}`, 'error');
                return {};
            }
        }

        function extractGeoObjectData() {
            // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ geoObject –∏–∑ –±–∞–ª—É–Ω–∞
            const balloonData = myMap.balloon.getData();
            let geoObject = balloonData.geoObject;
            
            // –ï—Å–ª–∏ geoObject –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            if (!geoObject) {
                addLog('‚ö†Ô∏è geoObject –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∞–Ω–Ω—ã—Ö –±–∞–ª—É–Ω–∞, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã', 'warning');
                
                // –ú–µ—Ç–æ–¥ 1: –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∫–∞—Ä—Ç—ã
                try {
                    const activeObjects = myMap.geoObjects.getActiveObject();
                    if (activeObjects) {
                        geoObject = activeObjects;
                        addLog('‚úÖ geoObject –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –∫–∞—Ä—Ç—ã', 'success');
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:', e);
                }
                
                // –ú–µ—Ç–æ–¥ 2: –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∏–∫–Ω—É—Ç—ã–π –æ–±—ä–µ–∫—Ç
                if (!geoObject && window.lastClickedGeoObject) {
                    geoObject = window.lastClickedGeoObject;
                    addLog('‚úÖ geoObject –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–ª–∏–∫–Ω—É—Ç—ã–π –æ–±—ä–µ–∫—Ç', 'success');
                }
                
                // –ú–µ—Ç–æ–¥ 3: –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ
                if (!geoObject) {
                    try {
                        const allObjects = myMap.geoObjects.getAll();
                        if (allObjects && allObjects.length > 0) {
                            // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –æ–±—ä–µ–∫—Ç (–æ–±—ã—á–Ω–æ —ç—Ç–æ —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –∫–ª–∏–∫–Ω—É—Ç)
                            geoObject = allObjects[0];
                            addLog('‚úÖ geoObject –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –∫–∞—Ä—Ç—ã', 'success');
                        }
                    } catch (e) {
                        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã:', e);
                    }
                }
            }
            
            if (!geoObject) {
                addLog('‚ùå geoObject –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –æ–¥–Ω–∏–º –∏–∑ –º–µ—Ç–æ–¥–æ–≤', 'error');
                return {};
            }

            try {
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤
                const safeProperties = {};
                try {
                    const properties = geoObject.properties.getAll();
                    addLog(`üìã –ù–∞–π–¥–µ–Ω–æ ${Object.keys(properties).length} —Å–≤–æ–π—Å—Ç–≤ geoObject`, 'info');
                    for (let key in properties) {
                        try {
                            const value = properties[key];
                            if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {
                                safeProperties[key] = value;
                            } else {
                                safeProperties[key] = String(value);
                            }
                        } catch (e) {
                            safeProperties[key] = '<error reading property>';
                        }
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ geoObject:', e);
                    addLog('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ geoObject', 'warning');
                }

                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                let lat = null, lng = null;
                try {
                    const geometry = geoObject.geometry.getCoordinates();
                    if (geometry && Array.isArray(geometry) && geometry.length >= 2) {
                        lat = geometry[0];
                        lng = geometry[1];
                        addLog(`üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat}, ${lng}`, 'info');
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', e);
                    addLog('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã', 'warning');
                }

                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
                let address = '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω';
                try {
                    const addressLine = geoObject.getAddressLine();
                    if (addressLine && typeof addressLine === 'string') {
                        address = addressLine;
                        addLog(`üè† –ê–¥—Ä–µ—Å: ${address}`, 'info');
                    }
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å:', e);
                    addLog('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å', 'warning');
                }

                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                let name = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ';
                try {
                    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —Å–≤–æ–π—Å—Ç–≤
                    if (safeProperties.name) {
                        name = safeProperties.name;
                    } else if (safeProperties.hint) {
                        name = safeProperties.hint;
                    } else if (safeProperties.title) {
                        name = safeProperties.title;
                    } else if (safeProperties.text) {
                        name = safeProperties.text;
                    } else {
                        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —Å–∞–º–æ–≥–æ geoObject
                        const geoObjectName = geoObject.get('name') || geoObject.get('hint') || geoObject.get('title');
                        if (geoObjectName) {
                            name = geoObjectName;
                        }
                    }
                    addLog(`üè™ –ù–∞–∑–≤–∞–Ω–∏–µ: ${name}`, 'info');
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ:', e);
                }
                
                return {
                    name: name,
                    address: address,
                    phone: safeProperties.phone || safeProperties.Phones || '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω',
                    website: safeProperties.website || safeProperties.url || '–°–∞–π—Ç –Ω–µ —É–∫–∞–∑–∞–Ω',
                    hours: safeProperties.hours || safeProperties.working_hours || '–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã',
                    rating: safeProperties.rating || safeProperties.rating_value || '–†–µ–π—Ç–∏–Ω–≥ –Ω–µ —É–∫–∞–∑–∞–Ω',
                    reviews_count: safeProperties.reviews_count || safeProperties.reviews || '–û—Ç–∑—ã–≤—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã',
                    description: safeProperties.description || safeProperties.comment || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ',
                    type: safeProperties.kind || safeProperties.type || 'venue',
                    lat: lat,
                    lng: lng,
                    full_properties: safeProperties
                };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö geoObject:', error);
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö geoObject: ${error.message}`, 'error');
                return {
                    name: '–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö',
                    address: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å',
                    phone: '–ù–µ —É–∫–∞–∑–∞–Ω',
                    website: '–ù–µ —É–∫–∞–∑–∞–Ω',
                    hours: '–ù–µ —É–∫–∞–∑–∞–Ω—ã',
                    rating: '–ù–µ —É–∫–∞–∑–∞–Ω',
                    reviews_count: '–ù–µ —É–∫–∞–∑–∞–Ω—ã',
                    description: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö',
                    type: 'venue',
                    lat: null,
                    lng: null,
                    full_properties: {}
                };
            }
        }

        function safeStringify(obj) {
            const seen = new WeakSet();
            return JSON.stringify(obj, function(key, val) {
                if (val != null && typeof val === "object") {
                    if (seen.has(val)) {
                        return "<circular reference>";
                    }
                    seen.add(val);
                }
                return val;
            });
        }

        function sendDataToServer(geoObjectData, balloonData, htmlContent) {
            addLog('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...', 'info');

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç)
            const limitedHtmlContent = htmlContent ? htmlContent.substring(0, 2000) : '';
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–≤–∫–ª—é—á–∞–µ–º –±–æ–ª—å—à–µ –ø–æ–ª–µ–π)
            const safeData = {
                geoObject: {
                    name: geoObjectData.name,
                    address: geoObjectData.address,
                    phone: geoObjectData.phone,
                    website: geoObjectData.website,
                    hours: geoObjectData.hours,
                    rating: geoObjectData.rating,
                    reviews_count: geoObjectData.reviews_count,
                    description: geoObjectData.description,
                    type: geoObjectData.type,
                    lat: geoObjectData.lat,
                    lng: geoObjectData.lng,
                    full_properties: geoObjectData.full_properties || {},
                    all_links: geoObjectData.all_links || [],
                    links_count: geoObjectData.links_count || 0
                },
                balloonData: {
                    content: balloonData.content ? balloonData.content.substring(0, 1000) : '',
                    properties: balloonData.properties || {}
                },
                htmlContent: limitedHtmlContent
            };

            try {
                // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
                let jsonData = safeStringify(safeData);
                
                addLog(`üìè –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${jsonData.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (—É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç)
                if (jsonData.length > 100000) { // 100KB –ª–∏–º–∏—Ç
                    addLog('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é', 'warning');
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const minimalData = {
                        geoObject: {
                            name: geoObjectData.name,
                            address: geoObjectData.address,
                            phone: geoObjectData.phone,
                            website: geoObjectData.website,
                            lat: geoObjectData.lat,
                            lng: geoObjectData.lng
                        },
                        balloonData: {},
                        htmlContent: ''
                    };
                    jsonData = safeStringify(minimalData);
                    addLog(`üìè –†–∞–∑–º–µ—Ä —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${jsonData.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
                }
                
                fetch('/api/extract-balloon-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: jsonData
                })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 413) {
                            throw new Error('–î–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        extractedInfo = data.data;
                        displayExtractedData(extractedInfo);
                        saveToFile(extractedInfo);
                        addLog('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã', 'success');
                        showNotification('‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∞!');
                    } else {
                        addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${data.error}`, 'error');
                        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                    addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
                    showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                addLog(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        function displayExtractedData(data) {
            const container = document.getElementById('extracted-data');
            const content = document.getElementById('data-content');
            
            content.innerHTML = '';
            
            const fields = [
                { label: '–ù–∞–∑–≤–∞–Ω–∏–µ', key: 'name' }
            ];

            fields.forEach(field => {
                let value = data[field.key];
                
                if (field.key === 'coords') {
                    value = data.lat && data.lng ? `${data.lat}, ${data.lng}` : '–ù–µ —É–∫–∞–∑–∞–Ω—ã';
                } else if (field.key === 'all_links') {
                    if (Array.isArray(value) && value.length > 0) {
                        value = value.join(' | ');
                    } else {
                        value = '–°—Å—ã–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                    }
                }
                
                if (value && value !== '–ù–µ —É–∫–∞–∑–∞–Ω–æ' && value !== '–ù–µ —É–∫–∞–∑–∞–Ω' && value !== '–ù–µ —É–∫–∞–∑–∞–Ω—ã' && value !== '–°—Å—ã–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'data-field';
                    fieldDiv.innerHTML = `
                        <span class="data-label">${field.label}:</span>
                        <span class="data-value">${value}</span>
                    `;
                    content.appendChild(fieldDiv);
                }
            });
            
            container.style.display = 'block';
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('venue-input').value = data.name;
        }

        function saveToFile(data) {
            addLog('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ñ–∞–π–ª...', 'info');

            fetch('/api/save-balloon-info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    balloon_info: data
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    addLog(`‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${result.filename}`, 'success');
                    addLog(`üìÅ –ü—É—Ç—å: ${result.filepath}`, 'info');
                    showNotification(`‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª: ${result.filename}`);
                } else {
                    addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${result.error}`, 'error');
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
                addLog(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ${error.message}`, 'error');
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
            });
        }

        function createTestVenues() {
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è
            testVenues.forEach(function(venue) {
                myMap.geoObjects.remove(venue);
            });
            testVenues = [];

            const center = myMap.getCenter();
            const venues = [
                {
                    name: '–ö–∞—Ñ–µ "–£—é—Ç–Ω–æ–µ –º–µ—Å—Ç–æ"',
                    phone: '+7 (495) 123-45-67',
                    address: '—É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, 15',
                    website: 'https://cafe-uyut.ru',
                    hours: '09:00 - 23:00',
                    rating: '4.5',
                    reviews_count: '127',
                    description: '–£—é—Ç–Ω–æ–µ –∫–∞—Ñ–µ —Å –¥–æ–º–∞—à–Ω–µ–π –∫—É—Ö–Ω–µ–π',
                    lat: center[0] + 0.001,
                    lng: center[1] + 0.001
                },
                {
                    name: '–†–µ—Å—Ç–æ—Ä–∞–Ω "–í–∫—É—Å–Ω–∞—è –µ–¥–∞"',
                    phone: '+7 (495) 234-56-78',
                    address: '—É–ª. –ê—Ä–±–∞—Ç, 25',
                    website: 'https://vkusnoe-ed.ru',
                    hours: '10:00 - 00:00',
                    rating: '4.8',
                    reviews_count: '89',
                    description: '–†–µ—Å—Ç–æ—Ä–∞–Ω –µ–≤—Ä–æ–ø–µ–π—Å–∫–æ–π –∫—É—Ö–Ω–∏',
                    lat: center[0] - 0.001,
                    lng: center[1] + 0.002
                },
                {
                    name: '–ö–æ—Ñ–µ–π–Ω—è "–ê—Ä–æ–º–∞—Ç"',
                    phone: '+7 (495) 345-67-89',
                    address: '–ö—É—Ç—É–∑–æ–≤—Å–∫–∏–π –ø—Ä-—Ç, 10',
                    website: 'https://coffee-aromat.ru',
                    hours: '07:00 - 22:00',
                    rating: '4.3',
                    reviews_count: '203',
                    description: '–ö–æ—Ñ–µ–π–Ω—è —Å –∞–≤—Ç–æ—Ä—Å–∫–∏–º–∏ –Ω–∞–ø–∏—Ç–∫–∞–º–∏',
                    lat: center[0] + 0.002,
                    lng: center[1] - 0.001
                }
            ];

            venues.forEach(function(venue) {
                const balloonContent = `
                    <div style="padding: 15px; font-family: Arial, sans-serif; max-width: 300px;">
                        <h3 style="margin: 0 0 10px 0; color: #333; font-size: 1.2em;">${venue.name}</h3>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>üìû –¢–µ–ª–µ—Ñ–æ–Ω:</strong> <a href="tel:${venue.phone}" style="color: #2196F3;">${venue.phone}</a>
                        </p>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>üìç –ê–¥—Ä–µ—Å:</strong> ${venue.address}
                        </p>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>üåê –°–∞–π—Ç:</strong> <a href="${venue.website}" target="_blank" style="color: #2196F3;">${venue.website}</a>
                        </p>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>üïí –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</strong> ${venue.hours}
                        </p>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>‚≠ê –†–µ–π—Ç–∏–Ω–≥:</strong> ${venue.rating} (${venue.reviews_count} –æ—Ç–∑—ã–≤–æ–≤)
                        </p>
                        <p style="margin: 5px 0; color: #666;">
                            <strong>üìù –û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${venue.description}
                        </p>
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="extractFromActiveBalloon()" 
                                    style="background: #4CAF50; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                üéØ –ò–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                            </button>
                        </div>
                    </div>
                `;

                const venuePlacemark = new ymaps.Placemark([venue.lat, venue.lng], {
                    balloonContent: balloonContent
                }, {
                    preset: 'islands#blueDotIcon',
                    iconColor: '#2196F3'
                });

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
                venuePlacemark.properties.set('name', venue.name);
                venuePlacemark.properties.set('phone', venue.phone);
                venuePlacemark.properties.set('address', venue.address);
                venuePlacemark.properties.set('website', venue.website);
                venuePlacemark.properties.set('hours', venue.hours);
                venuePlacemark.properties.set('rating', venue.rating);
                venuePlacemark.properties.set('reviews_count', venue.reviews_count);
                venuePlacemark.properties.set('description', venue.description);
                venuePlacemark.properties.set('kind', 'venue');

                myMap.geoObjects.add(venuePlacemark);
                testVenues.push(venuePlacemark);
            });

            addLog(`üè™ –°–æ–∑–¥–∞–Ω–æ ${venues.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π`, 'success');
            showNotification(`‚úÖ –°–æ–∑–¥–∞–Ω–æ ${venues.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π! –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å–∏–Ω–∏–µ –º–µ—Ç–∫–∏.`);
        }

        function clearMap() {
            testVenues.forEach(function(venue) {
                myMap.geoObjects.remove(venue);
            });
            testVenues = [];
            
            if (myMap.balloon && myMap.balloon.isOpen()) {
                myMap.balloon.close();
            }
            
            addLog('üóëÔ∏è –ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
            showNotification('üóëÔ∏è –ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            addLog('üìù –õ–æ–≥ –æ—á–∏—â–µ–Ω', 'info');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            logContainer.appendChild(logEntry);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            initMap();
        };
    </script>
</body>
</html> 