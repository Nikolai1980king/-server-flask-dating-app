<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã IP-–∫–æ–Ω—Ç—Ä–æ–ª—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
            color: white;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
        }
        .info {
            border-left-color: #2196F3;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Ç—Ä–æ–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h1>
    
    <div class="test-section">
        <h2>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ</h2>
        <p><strong>–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:</strong> –û–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ = –æ–¥–Ω–∞ –∞–Ω–∫–µ—Ç–∞</p>
        <p><strong>–¶–µ–ª—å:</strong> –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∞–Ω–∫–µ—Ç —Å –æ–¥–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</p>
        <p><strong>–ú–µ—Ç–æ–¥:</strong> –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: IP-–∞–¥—Ä–µ—Å + –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</p>
        <p><strong>–û—Ç–ø–µ—á–∞—Ç–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</strong> User-Agent + Accept-Language + Accept-Encoding + IP</p>
    </div>

    <div class="test-section">
        <h2>üîç –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π –∞–Ω–∫–µ—Ç—ã</h2>
        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É. –≠—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ.</p>
        <button onclick="testCreateProfile()">–°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É</button>
        <div id="test1-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üîÑ –¢–µ—Å—Ç 2: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã</h2>
        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É —Å–Ω–æ–≤–∞ —Å —Ç–æ–≥–æ –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. –î–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å.</p>
        <button onclick="testCreateProfileAgain()">–°–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É —Å–Ω–æ–≤–∞</button>
        <div id="test2-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üåê –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ IP-–∞–¥—Ä–µ—Å–∞ –∏ –æ—Ç–ø–µ—á–∞—Ç–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
        <p>–ü—Ä–æ–≤–µ—Ä–∏–º, –∫–∞–∫–æ–π IP-–∞–¥—Ä–µ—Å –∏ –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤–∏–¥–∏—Ç —Å–µ—Ä–≤–µ—Ä.</p>
        <button onclick="checkIP()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å IP –∏ –æ—Ç–ø–µ—á–∞—Ç–æ–∫</button>
        <div id="test3-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üìä –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
        <p>–ü—Ä–æ–≤–µ—Ä–∏–º –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö ip_control –∏ device_control.</p>
        <button onclick="checkDatabase()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</button>
        <div id="test4-result" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>üßπ –û—á–∏—Å—Ç–∫–∞</h2>
        <p>–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∫–æ–Ω—Ç—Ä–æ–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è).</p>
        <button onclick="clearIPControl()">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤</button>
        <div id="clear-result" class="result" style="display: none;"></div>
    </div>

    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.innerHTML = message;
        }

        async function testCreateProfile() {
            showResult('test1-result', '‚è≥ –°–æ–∑–¥–∞–µ–º –∞–Ω–∫–µ—Ç—É...', 'info');
            
            try {
                const response = await fetch('/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        age: '25',
                        gender: '–ú—É–∂—Å–∫–æ–π',
                        hobbies: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã',
                        goal: '–ü—Ä–æ–≤–µ—Ä–∫–∞ IP-–∫–æ–Ω—Ç—Ä–æ–ª—è',
                        venue: '–¢–µ—Å—Ç–æ–≤–æ–µ –∫–∞—Ñ–µ',
                        latitude: '55.7558',
                        longitude: '37.6176',
                        venue_lat: '55.7558',
                        venue_lng: '37.6176'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult('test1-result', `‚úÖ –ê–Ω–∫–µ—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!<br>User ID: ${data.user_id}<br>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${data.redirect}`, 'info');
                } else {
                    showResult('test1-result', `‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult('test1-result', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
            }
        }

        async function testCreateProfileAgain() {
            showResult('test2-result', '‚è≥ –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –∞–Ω–∫–µ—Ç—É —Å–Ω–æ–≤–∞...', 'info');
            
            try {
                const response = await fetch('/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        name: '–í—Ç–æ—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        age: '30',
                        gender: '–ñ–µ–Ω—Å–∫–∏–π',
                        hobbies: '–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ',
                        goal: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏',
                        venue: '–î—Ä—É–≥–æ–µ –∫–∞—Ñ–µ',
                        latitude: '55.7558',
                        longitude: '37.6176',
                        venue_lat: '55.7558',
                        venue_lng: '37.6176'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showResult('test2-result', `‚úÖ –ê–Ω–∫–µ—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!<br>User ID: ${data.user_id}`, 'info');
                } else {
                    if (data.redirect_url) {
                        showResult('test2-result', `üîÑ IP-–∫–æ–Ω—Ç—Ä–æ–ª—å —Å—Ä–∞–±–æ—Ç–∞–ª!<br>–û—à–∏–±–∫–∞: ${data.error}<br>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${data.redirect_url}`, 'info');
                    } else {
                        showResult('test2-result', `‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
                    }
                }
            } catch (error) {
                showResult('test2-result', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`, 'error');
            }
        }

        async function checkIP() {
            showResult('test3-result', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º IP-–∞–¥—Ä–µ—Å –∏ –æ—Ç–ø–µ—á–∞—Ç–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...', 'info');
            
            try {
                const response = await fetch('/check_ip');
                const data = await response.json();
                
                let html = `üåê IP-–∞–¥—Ä–µ—Å: ${data.ip}<br>`;
                html += `üîç –û—Ç–ø–µ—á–∞—Ç–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${data.device_fingerprint}<br>`;
                html += `üì± –¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${data.device_info.is_mobile ? '–ú–æ–±–∏–ª—å–Ω–æ–µ' : '–î–µ—Å–∫—Ç–æ–ø–Ω–æ–µ'}<br>`;
                html += `üì± User-Agent: ${data.device_info.user_agent}<br>`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö
                if (data.restrictions) {
                    html += `<br><strong>üîí –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:</strong><br>`;
                    html += `‚Ä¢ IP-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: ${data.restrictions.ip_restriction.has_existing ? '–ï–°–¢–¨' : '–ù–ï–¢'}`;
                    if (data.restrictions.ip_restriction.has_existing) {
                        html += ` (Profile: ${data.restrictions.ip_restriction.profile_id})`;
                    }
                    html += `<br>`;
                    html += `‚Ä¢ Device-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: ${data.restrictions.device_restriction.has_existing ? '–ï–°–¢–¨' : '–ù–ï–¢'}`;
                    if (data.restrictions.device_restriction.has_existing) {
                        html += ` (Profile: ${data.restrictions.device_restriction.profile_id})`;
                    }
                    html += `<br>`;
                }
                
                html += `<details><summary>–í—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏</summary><pre>${JSON.stringify(data.headers, null, 2)}</pre></details>`;
                
                showResult('test3-result', html, 'info');
            } catch (error) {
                showResult('test3-result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function checkDatabase() {
            showResult('test4-result', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...', 'info');
            
            try {
                const response = await fetch('/check_ip_control');
                const data = await response.json();
                
                let html = '';
                
                // IP Control
                if (data.ip_control && data.ip_control.records && data.ip_control.records.length > 0) {
                    html += 'üìä –ó–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ ip_control:<br>';
                    data.ip_control.records.forEach(record => {
                        html += `‚Ä¢ IP: ${record.ip_address} ‚Üí Profile: ${record.profile_id}<br>`;
                    });
                    html += '<br>';
                } else {
                    html += 'üìä –¢–∞–±–ª–∏—Ü–∞ ip_control –ø—É—Å—Ç–∞<br><br>';
                }
                
                // Device Control
                if (data.device_control && data.device_control.records && data.device_control.records.length > 0) {
                    html += 'üîç –ó–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ device_control:<br>';
                    data.device_control.records.forEach(record => {
                        html += `‚Ä¢ Device: ${record.device_fingerprint.substring(0, 8)}... ‚Üí Profile: ${record.profile_id}<br>`;
                        html += `  IP: ${record.ip_address}<br>`;
                        html += `  –¢–∏–ø: ${record.is_mobile ? '–ú–æ–±–∏–ª—å–Ω–æ–µ' : '–î–µ—Å–∫—Ç–æ–ø–Ω–æ–µ'}<br>`;
                        html += `  User-Agent: ${record.user_agent ? record.user_agent.substring(0, 50) + '...' : 'N/A'}<br><br>`;
                    });
                } else {
                    html += 'üîç –¢–∞–±–ª–∏—Ü–∞ device_control –ø—É—Å—Ç–∞<br>';
                }
                
                showResult('test4-result', html, 'info');
            } catch (error) {
                showResult('test4-result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function clearIPControl() {
            showResult('clear-result', '‚è≥ –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤...', 'info');
            
            try {
                const response = await fetch('/clear_ip_control', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showResult('clear-result', '‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –æ—á–∏—â–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'info');
                } else {
                    showResult('clear-result', `‚ùå –û—à–∏–±–∫–∞: ${data.error}`, 'error');
                }
            } catch (error) {
                showResult('clear-result', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>