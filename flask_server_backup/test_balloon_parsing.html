<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –±–∞–ª—É–Ω–æ–≤</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://api-maps.yandex.ru/2.1/?apikey=9a3beffb-a8a0-4d55-850f-d258dd28c104&lang=ru_RU" type="text/javascript"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        #map {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .controls {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: linear-gradient(90deg, #ff6b6b 0%, #ffb86b 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            opacity: 0.8;
        }
        .result {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –±–∞–ª—É–Ω–æ–≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç</h1>
        
        <div class="controls">
            <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</h3>
            <ol>
                <li>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ</li>
                <li>–î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ—è–≤–ª–µ–Ω–∏—è –±–∞–ª—É–Ω–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–≤–µ–¥–µ–Ω–∏–∏</li>
                <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üîç –ü–∞—Ä—Å–∏—Ç—å –±–∞–ª—É–Ω"</li>
                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ –∏ –Ω–∏–∂–µ</li>
            </ol>
            
            <button onclick="parseCurrentBalloon()">üîç –ü–∞—Ä—Å–∏—Ç—å –±–∞–ª—É–Ω</button>
            <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            <button onclick="showAllElements()">üîç –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã</button>
        </div>

        <div id="map"></div>
        
        <div class="controls">
            <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—Ä—Å–∏–Ω–≥–∞:</h3>
            <div id="results" class="result">–ù–∞–∂–º–∏—Ç–µ "–ü–∞—Ä—Å–∏—Ç—å –±–∞–ª—É–Ω" –¥–ª—è –Ω–∞—á–∞–ª–∞...</div>
        </div>
    </div>

    <script>
        let myMap, myPlacemark;
        let results = [];

        function initMap() {
            ymaps.ready(function () {
                myMap = new ymaps.Map('map', {
                    center: [55.76, 37.64], // –ú–æ—Å–∫–≤–∞
                    zoom: 12,
                    controls: ['zoomControl', 'fullscreenControl']
                });

                myMap.events.add('click', function (e) {
                    var coords = e.get('coords');
                    setLocation(coords[0], coords[1]);
                });
            });
        }

        function setLocation(lat, lng) {
            if (myPlacemark) {
                myMap.geoObjects.remove(myPlacemark);
            }

            myPlacemark = new ymaps.Placemark([lat, lng], {
                balloonContent: '–í—ã–±—Ä–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'
            }, {
                preset: 'islands#redDotIcon'
            });

            myMap.geoObjects.add(myPlacemark);
            myMap.setCenter([lat, lng], 15);

            // –ò—â–µ–º –∑–∞–≤–µ–¥–µ–Ω–∏—è –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
            searchVenuesAtLocation(lat, lng);
        }

        function searchVenuesAtLocation(lat, lng) {
            ymaps.geocode([lat, lng], {
                results: 10,
                kind: 'biz'
            }).then(function(res) {
                if (res.geoObjects.getLength() > 0) {
                    const geoObject = res.geoObjects.get(0);
                    const name = geoObject.getAddressLine();
                    const address = geoObject.getAddressLine();
                    
                    myPlacemark.properties.set('balloonContent',
                        `<div style="padding: 10px;">
                            <h3>${name}</h3>
                            <p>${address}</p>
                            <button onclick="parseBalloonAndShowResults('${name}', '${address}', ${lat}, ${lng})"
                                    style="background: #ff6b6b; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                üîç –ü–∞—Ä—Å–∏—Ç—å —ç—Ç–æ –∑–∞–≤–µ–¥–µ–Ω–∏–µ
                            </button>
                        </div>`
                    );
                    myPlacemark.balloon.open();
                }
            });
        }

        function parseCurrentBalloon() {
            addResult('üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª—É–Ω–∞...', 'info');
            
            const parsedName = extractNameFromBalloon();
            
            if (parsedName) {
                addResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ: "${parsedName}"`, 'success');
            } else {
                addResult('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            debugBalloonStructure();
        }

        function parseBalloonAndShowResults(name, address, lat, lng) {
            addResult(`üéØ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ–¥–µ–Ω–∏—è: ${name}`, 'info');
            
            const parsedName = extractNameFromBalloon();
            
            addResult(`üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:`, 'info');
            addResult(`  –ò—Å—Ö–æ–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: ${name}`, 'info');
            addResult(`  –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: ${parsedName || '–ù–ï –ù–ê–ô–î–ï–ù–û'}`, parsedName ? 'success' : 'error');
            addResult(`  –§–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: ${parsedName || name}`, 'info');
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            debugBalloonStructure();
        }

        function extractNameFromBalloon() {
            try {
                addResult('üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ –±–∞–ª—É–Ω–∞...', 'info');
                
                // –ò—â–µ–º –±–∞–ª—É–Ω –ø–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–º —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º
                let balloonContent = document.querySelector('.ymaps-2-1-79-balloon');
                if (!balloonContent) {
                    balloonContent = document.querySelector('.ymaps-balloon');
                }
                if (!balloonContent) {
                    balloonContent = document.querySelector('.balloon');
                }
                if (!balloonContent) {
                    balloonContent = document.querySelector('[class*="balloon"]');
                }
                if (!balloonContent) {
                    balloonContent = document.querySelector('[class*="ymaps"]');
                }
                
                if (!balloonContent) {
                    addResult('‚ùå –ë–∞–ª—É–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return null;
                }
                
                addResult(`‚úÖ –ë–∞–ª—É–Ω –Ω–∞–π–¥–µ–Ω: ${balloonContent.className}`, 'success');
                
                // –ü–æ–ª—É—á–∞–µ–º HTML –∫–æ–Ω—Ç–µ–Ω—Ç
                const htmlContent = balloonContent.innerHTML;
                addResult(`üìè –†–∞–∑–º–µ—Ä HTML: ${htmlContent.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');
                
                // –ò—â–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏ –≤ –±–∞–ª—É–Ω–µ
                const links = balloonContent.querySelectorAll('a');
                addResult(`üîó –ù–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫: ${links.length}`, 'info');
                
                if (links.length > 0) {
                    for (let i = 0; i < links.length; i++) {
                        const link = links[i];
                        const linkText = link.textContent.trim();
                        addResult(`üîó –°—Å—ã–ª–∫–∞ ${i + 1}: "${linkText}"`, 'info');
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ —Å–ª—É–∂–µ–±–Ω–∞—è —Å—Å—ã–ª–∫–∞
                        if (isValidVenueName(linkText)) {
                            addResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Å—Å—ã–ª–∫–µ: "${linkText}"`, 'success');
                            return linkText;
                        }
                    }
                }
                
                // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                const headers = balloonContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
                addResult(`üìã –ù–∞–π–¥–µ–Ω–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: ${headers.length}`, 'info');
                
                for (let header of headers) {
                    const headerText = header.textContent.trim();
                    addResult(`üìã –ó–∞–≥–æ–ª–æ–≤–æ–∫: "${headerText}"`, 'info');
                    
                    if (isValidVenueName(headerText)) {
                        addResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ: "${headerText}"`, 'success');
                        return headerText;
                    }
                }
                
                // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∫–ª–∞—Å—Å–∞–º–∏ name/title
                const nameElements = balloonContent.querySelectorAll('[class*="name"], [class*="title"]');
                addResult(`üè∑Ô∏è –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å name/title: ${nameElements.length}`, 'info');
                
                for (let element of nameElements) {
                    const elementText = element.textContent.trim();
                    addResult(`üè∑Ô∏è –≠–ª–µ–º–µ–Ω—Ç —Å name/title: "${elementText}"`, 'info');
                    
                    if (isValidVenueName(elementText)) {
                        addResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —ç–ª–µ–º–µ–Ω—Ç–µ —Å name/title: "${elementText}"`, 'success');
                        return elementText;
                    }
                }
                
                // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –∏—â–µ–º –ø–µ—Ä–≤—ã–π –∑–Ω–∞—á–∏–º—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
                const allElements = balloonContent.querySelectorAll('*');
                addResult(`üîç –í—Å–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –±–∞–ª—É–Ω–µ: ${allElements.length}`, 'info');
                
                for (let element of allElements) {
                    const text = element.textContent.trim();
                    if (isValidVenueName(text)) {
                        addResult(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ: "${text}"`, 'success');
                        return text;
                    }
                }
                
                addResult('‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                
            } catch (error) {
                addResult(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ: ${error.message}`, 'error');
            }
            
            return null;
        }

        function isValidVenueName(name) {
            return name && name.length > 2 && name.length < 100 &&
                !name.includes('Share') && !name.includes('–ü–æ–¥–µ–ª–∏—Ç—å—Å—è') &&
                !name.includes('–¢–µ–ª–µ—Ñ–æ–Ω') && !name.includes('–ê–¥—Ä–µ—Å') &&
                !name.includes('–ß–∞—Å—ã') && !name.includes('–†–µ–π—Ç–∏–Ω–≥') &&
                !name.includes('–û—Ç–∫—Ä—ã—Ç–æ') && !name.includes('–ó–∞–∫—Ä—ã—Ç–æ') &&
                !name.includes('www.') && !name.includes('http') &&
                !name.includes('+7') && !name.includes('8-') &&
                !name.match(/^\d+$/) && !name.match(/^\d+\.\d+$/) &&
                !name.includes('–æ—Ç–∑—ã–≤') && !name.includes('–æ—Ç–∑—ã–≤–æ–≤') &&
                !name.includes('–ü–æ–∫–∞–∑–∞—Ç—å') && !name.includes('–ù–∞–ø–∏—Å–∞—Ç—å') &&
                !name.includes('–ü–æ–∑–≤–æ–Ω–∏—Ç—å') && !name.includes('–ü–æ–¥–µ–ª–∏—Ç—å—Å—è');
        }

        function debugBalloonStructure() {
            addResult('üîç –û—Ç–ª–∞–¥–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–ª—É–Ω–∞...', 'info');
            
            const selectors = [
                '.ymaps-2-1-79-balloon',
                '.ymaps-balloon', 
                '.balloon',
                '[class*="balloon"]',
                '[class*="ymaps"]'
            ];
            
            for (let selector of selectors) {
                const elements = document.querySelectorAll(selector);
                addResult(`üîç –°–µ–ª–µ–∫—Ç–æ—Ä "${selector}": –Ω–∞–π–¥–µ–Ω–æ ${elements.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`, 'info');
                
                for (let i = 0; i < elements.length; i++) {
                    const element = elements[i];
                    addResult(`  –≠–ª–µ–º–µ–Ω—Ç ${i + 1}: ${element.className} (${element.tagName})`, 'info');
                    addResult(`    –¢–µ–∫—Å—Ç: "${element.textContent.substring(0, 50)}..."`, 'info');
                }
            }
            
            const allLinks = document.querySelectorAll('a');
            addResult(`üîó –í—Å–µ–≥–æ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: ${allLinks.length}`, 'info');
            
            for (let i = 0; i < Math.min(allLinks.length, 5); i++) {
                const link = allLinks[i];
                addResult(`  –°—Å—ã–ª–∫–∞ ${i + 1}: "${link.textContent.trim()}"`, 'info');
            }
        }

        function showAllElements() {
            addResult('üîç –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ...', 'info');
            
            const allElements = document.querySelectorAll('*');
            addResult(`üìä –í—Å–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ: ${allElements.length}`, 'info');
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–µ–≥–∞–º
            const tagCounts = {};
            for (let element of allElements) {
                const tag = element.tagName;
                tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            }
            
            for (let tag in tagCounts) {
                addResult(`  ${tag}: ${tagCounts[tag]}`, 'info');
            }
        }

        function addResult(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const result = `[${timestamp}] ${message}`;
            results.push({ message: result, type: type });
            
            updateResultsDisplay();
            console.log(result);
        }

        function updateResultsDisplay() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = results.map(r => 
                `<div class="${r.type}">${r.message}</div>`
            ).join('');
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            results = [];
            updateResultsDisplay();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            initMap();
            addResult('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∫–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'success');
        };
    </script>
</body>
</html> 